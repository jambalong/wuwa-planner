<%# locals: (subject:, plan_type:, errors: nil) %>

<div id="plan-form-frame">
  <% if errors.present? %>
    <div
      class="
        mb-2 p-2 bg-ctp-red/20 border border-ctp-red text-ctp-red rounded-lg
      "
    >
      <ul class="list-disc ml-5">
        <% errors.each do |msg| %>
          <li><%= msg %></li>
        <% end %>
      </ul>
    </div>
  <% end %>

  <%= form_with(model: Plan.new, url: plans_path, method: :post, data: { controller: "plan-form" }, id: "plan-form") do |f| %>
    <%# Hidden fields to tell the Controller what we selected in Steps 1 & 2 %>
    <%= f.hidden_field :plan_type, value: plan_type %>
    <%= f.hidden_field :subject_id, value: subject.id %>

    <div class="grid grid-cols-2 gap-4 mb-8">
      <%# Level Section %>
      <div class="p-4">
        <h2
          class="
            text-[10px] uppercase tracking-widest text-ctp-text font-black mb-3
          "
        >Level</h2>
        <div class="flex items-center justify-between gap-2">
          <div class="level-input-wrapper">
            <%= f.number_field :current_level,
                           value: 1,
                           min: 1,
                           max: 90,
                           class: "custom-number-input current",
                           data: {
                             action: "input->plan-form#clampLevel",
                           } %>
          </div>

          <span class="text-ctp-text">→</span>

          <div class="level-input-wrapper">
            <%= f.number_field :target_level,
                           value: 90,
                           min: 1,
                           max: 90,
                           class: "custom-number-input target",
                           data: {
                             action: "input->plan-form#clampLevel",
                           } %>
          </div>
        </div>
      </div>

      <%# Ascension Section %>
      <div class="p-4">
        <h2
          class="
            text-[10px] uppercase tracking-widest text-ctp-text font-black mb-3
          "
        >Ascension Rank</h2>
        <div class="flex items-center justify-between gap-2">
          <div class="level-input-wrapper">
            <%= f.number_field :current_ascension_rank,
                           value: 0,
                           min: 0,
                           max: 6,
                           class: "custom-number-input current",
                           data: {
                             action: "input->plan-form#clampAscensionRank",
                           } %>
          </div>

          <span class="text-white">→</span>

          <div class="level-input-wrapper">
            <%= f.number_field :target_ascension_rank,
                           value: 6,
                           min: 0,
                           max: 6,
                           class: "custom-number-input target",
                           data: {
                             action: "input->plan-form#clampAscensionRank",
                           } %>
          </div>
        </div>
      </div>
    </div>

    <% if plan_type == "Resonator" %>
      <%# The Forte Grid %>
      <div class="flex justify-between items-end gap-2">

        <% [
          { label: "Basic Attack", key: "basic_attack" },
          { label: "Resonance Skill", key: "resonance_skill" },
          { label: "Forte Circuit", key: "forte_circuit", inherent: true },
          { label: "Resonance Liberation", key: "resonance_liberation" },
          { label: "Intro Skill", key: "intro_skill" }
        ].each do |config| %>
          <div class="forte-column <%= 'inherent-node' if config[:inherent] %>">

            <%# Tier 2 Node %>
            <label class="node-label cursor-pointer">
              <%= f.check_box "#{config[:key]}_node_2",
                          { class: "peer hidden", checked: true },
                          1,
                          0 %>
              <div class="node-circle node-2">
                <span>✱</span>
              </div>
            </label>

            <div class="node-connector"></div>

            <%# Tier 1 Node %>
            <label class="node-label cursor-pointer">
              <%= f.check_box "#{config[:key]}_node_1",
                          { class: "peer hidden", checked: true },
                          1,
                          0 %>
              <div class="node-circle node-1">
                <span>✱</span>
              </div>
            </label>

            <div class="node-connector"></div>

            <%# Skill Node (Diamond) %>
            <div class="node-diamond">
              <span>✱</span>
            </div>

            <%# Skill Level Indicators (1 -> 10) %>
            <div class="skill-level-text">
              <%# Current Value (connected to first slider) %>
              <span id="<%= config[:key] %>_current_val">1</span>
              <span>→</span>
              <%# Target Value (connected to second slider) %>
              <span id="<%= config[:key] %>_target_val">10</span>
            </div>

            <%# 2. Slider Group Container %>
            <div class="flex flex-col gap-1 w-full items-center">
              <%# Current Slider %>
              <div data-controller="slider" class="w-full">
                <%= f.range_field "#{config[:key]}_current",
                              min: 1,
                              max: 10,
                              value: 1,
                              class: "skill-slider",
                              data: {
                                slider_target: "input",
                                action: "input->slider#update",
                              } %>
                <%# Hidden label target to link to the span above %>
                <span
                  class="hidden"
                  data-slider-target="label"
                  data-link-id="<%= config[:key] %>_current_val"
                ></span>
              </div>

              <%# Target Slider %>
              <div data-controller="slider" class="w-full">
                <%= f.range_field "#{config[:key]}_target",
                              min: 1,
                              max: 10,
                              value: 10,
                              class: "skill-slider",
                              data: {
                                slider_target: "input",
                                action: "input->slider#update",
                              } %>
                <%# Hidden label target to link to the span above %>
                <span
                  class="hidden"
                  data-slider-target="label"
                  data-link-id="<%= config[:key] %>_target_val"
                ></span>
              </div>
            </div>
          </div>
        <% end %>

      </div>
    <% end %>

    <div class="pt-6">
      <%= f.submit "Create Plan",
               class:
                 "w-full py-3 px-4 bg-ctp-surface0 hover:bg-ctp-mauve text-ctp-text hover:text-ctp-base font-bold rounded-xl shadow-lg shadow-ctp-crust-200 transition-all cursor-pointer border-none" %>
    </div>
  <% end %>
</div>
